{% extends 'base.html' %}

<script>
    {% block jquery %}

    var dataEndpoint = {% url "get_chart_data" %};
    var sessionsEndpoint = {% url "session-list" %};
    var selectedSession = null;

    // Retrieving the sessions list
    $.ajax({
        method: "GET",
        url: sessionsEndpoint,
        success: function(sessions){
            console.log("success - sessions");
            console.log(sessions);
            for (let i=0; i<sessions.length; i++) {
                let sessionStartDate = sessions[i].start_date;
                let sessionChild = $('<li><a href="#">' + sessionStartDate + '</a></li>');
                $('#sessions-dropdown').append(sessionChild);
                sessionChild.click(function () {
                    selectedSession = sessions[i].id;
                    loadChart(selectedSession);
                })
            }
            loadChart(null);
        },
        error: function(error_data){
            console.log("Error retrieving the BBQ Sessions List");
            console.log(error_data);
        }
    });

    // Retrieving the data to be plotted
    function loadChart(selectedSession) {
        $.ajax({
            method: "GET",
            url: dataEndpoint,
            data: {"session": selectedSession},
            success: function(data){
                console.log("success");
                console.log(data);
                setChart(data);
            },
            error: function(error_data){
                console.log("Error retrieving the BBQ Data");
                console.log(error_data);
            }
        });
    }

    function setChart(data) {
        var ctx = document.getElementById("bbqChart").getContext('2d');
        var bbqChart = new Chart.Scatter(ctx, {
            data: data.data,
            options: {
                legend: {
                    labels: {
                        fontSize: 16
                    }
                },
                responsive: false,
                maintainAspectRatio: true,
                scales: {
                    xAxes: [{
                        position: 'bottom',
                        ticks: {
                            fontSize: 14,
                            userCallback: function(label, index, labels) {
                                return moment(label).format("DD/MM/YY HH:mm:ss");

                            }
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'x axis'
                        }
                    }],
                    yAxes: [{
                        position: 'left',
                        scaleLabel: {
                            display: true,
                            labelString: 'y axis'
                        },
                        ticks: {
                            fontSize: 18,
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    }
    {% endblock %}
</script>

{% block content %}

    <div class="mainWindow">
        <div class="windowHeader text-center">
            <h1>BBQ Thermometer Chart!</h1>
            <p>Some cool comment!</p>
            <div class="col-sm-12">
                <div class="col-sm-4">
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" id="sessions-button">BBQ Sessions List
                            <span class="caret"></span></button>
                        <ul class="dropdown-menu" id="sessions-dropdown"></ul>
                    </div>
                </div>
                <div class="col-sm-4">Text1!</div>
                <div class="col-sm-4">Text2!</div>
            </div>
        </div>
        <div class="windowBody">
            <canvas id="bbqChart" height="800px" width="1000 px"></canvas>
        </div>
    </div>

{% endblock content %}
